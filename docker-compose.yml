services:
  # PostgreSQL 数据库
  postgres:
    image: postgres:15-alpine
    container_name: image-hosting-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-image_hosting}
      POSTGRES_USER: ${DB_USER:-imghost}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme123}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # 备份目录映射（可选，便于访问数据库备份）
      - ./backups:/backups
    ports:
      # 仅在开发环境暴露端口，生产环境可以注释掉
      - "${DB_PORT:-5432}:5432"
    networks:
      - image-hosting-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-imghost} -d ${DB_NAME:-image_hosting}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Node.js 应用
  app:
    build:
      context: .
      dockerfile: Dockerfile  # 使用 npm install (兼容无 package-lock.json)
      # dockerfile: Dockerfile.optimized  # 使用 npm ci (需要 package-lock.json，构建更快更可靠)
      target: production
    container_name: image-hosting-app
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # 应用配置
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-3000}
      SESSION_SECRET: ${SESSION_SECRET:-change-this-secret-key-in-production}

      # 数据库配置（使用容器服务名）
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-image_hosting}
      DB_USER: ${DB_USER:-imghost}
      DB_PASSWORD: ${DB_PASSWORD:-changeme123}
      DB_SSL: ${DB_SSL:-false}

      # 存储配置
      STORAGE_TYPE: ${STORAGE_TYPE:-local}

      # R2/S3 配置（如果使用云存储）
      R2_ENABLED: ${R2_ENABLED:-false}
      R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID:-}
      R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY:-}
      R2_ENDPOINT: ${R2_ENDPOINT:-}
      R2_BUCKET: ${R2_BUCKET:-}
      R2_REGION: ${R2_REGION:-auto}
      R2_CUSTOM_DOMAIN: ${R2_CUSTOM_DOMAIN:-}

      # 图片处理配置
      IMAGE_QUALITY_WEBP: ${IMAGE_QUALITY_WEBP:-80}
      IMAGE_QUALITY_AVIF: ${IMAGE_QUALITY_AVIF:-75}
      IMAGE_QUALITY_PNG_OPTIMIZE: ${IMAGE_QUALITY_PNG_OPTIMIZE:-false}

      # 备份配置
      AUTO_BACKUP_ENABLED: ${AUTO_BACKUP_ENABLED:-true}
      AUTO_BACKUP_INTERVAL_HOURS: ${AUTO_BACKUP_INTERVAL_HOURS:-24}
      AUTO_BACKUP_KEEP_COUNT: ${AUTO_BACKUP_KEEP_COUNT:-7}
      PGDUMP_PATH: /usr/bin/pg_dump
      PSQL_PATH: /usr/bin/psql
    volumes:
      # 持久化上传的图片
      - ./uploads:/app/uploads
      # 持久化会话数据（如果不使用 Redis）
      - ./sessions:/app/sessions
      # 持久化备份
      - ./backups:/app/backups
      # 持久化日志
      - ./logs:/app/logs
      # 持久化配置（config.json）
      - ./config.json:/app/config.json
    ports:
      - "${APP_PORT:-3000}:3000"
    networks:
      - image-hosting-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

networks:
  image-hosting-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
